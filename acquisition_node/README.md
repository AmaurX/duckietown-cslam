# cSLAM data acquision node

The cSLAM data acquisition node is the part that connects to the edge devices (Duckiebots or watchtowers) processes their information (e.g. rectifies images and extracts april tag poses) and forwards this information to the graph optimization server. The acquisition node is designed to run as a Docker container, with one container responsible for a single device. This allows for easy load distribution across multiple devices.

## Prerequisites
To build and run the container you need to have Docker install. We recommend updating to the latest version. Testing was performed with version 18.06.1. In order to quickly launch containers for more than one device, we recommend using `docker-compose` and the provided `.yml` templates. Your `docker-compose` should work with version 3 configuration files. When in doubt, make sure you have the latest version. We tested with 1.23.1 and 1.23.2.

Make sure that all your devices (Duckiebots, watchtowers, computers running the acquisition nodes and computers running the graph optimization node) are on the same local network and can discover each other.

## How to use the acquisition node?

You can either build the container locally with the provided Dockerfile or pull it directly from `aleksandarpetrov/duckietown-cslam-acquisition` *(TODO: this should move to duckietown)*.

The container operations depend on a number of parameters you need to supply as environmental variables. Here is a list of these. Note that you always need to supply the variables in italics. The rest will assume the values in this table, unless you specify otherwise.

| **Variable**                   	| **Example/Default**          	| **Explanation**                                                                                                                                                                                                                                                                                                                                                                                                             	|
|--------------------------------	|------------------------------	|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------	|
| *ACQ_ROS_MASTER_URI_DEVICE*    	| *`watchtower05.local`*       	| Hostname of the device whose data this container will be processing. This should be a Duckiebot or watchtower.                                                                                                                                                                                                                                                                                                              	|
| *ACQ_ROS_MASTER_URI_DEVICE_IP* 	| *`192.168.1.48`*             	| IP address of this device                                                                                                                                                                                                                                                                                                                                                                                                   	|
| ACQ_ROS_MASTER_URI_DEVICE_PORT 	| `11311`                      	| Port of the ROS Master on this device                                                                                                                                                                                                                                                                                                                                                                                       	|
| *ACQ_ROS_MASTER_URI_SERVER*    	| *`mycomputer.local`*         	| Hostname of the device doing the graph optimization, or the device that hosts the ROS Master of the graph optimization node.                                                                                                                                                                                                                                                                                                	|
| *ACQ_ROS_MASTER_URI_SERVER_IP* 	| *`192.168.1.85`*             	| IP address of this device                                                                                                                                                                                                                                                                                                                                                                                                   	|
| ACQ_ROS_MASTER_URI_SERVER_PORT 	| `11311`                      	| Port of the ROS Master on this device                                                                                                                                                                                                                                                                                                                                                                                       	|
| *ACQ_DEVICE_NAME*              	| *`watchtower05`*             	| ROS name of the device whose data this container will be processing. All topics published by this device are assumed to be of the form `/ACQ_DEVICE_NAME/topic_name`                                                                                                                                                                                                                                                        	|
| ACQ_SOCKET_HOST                	| `127.0.0.1`                  	| Hostname for the interprocess socket communication                                                                                                                                                                                                                                                                                                                                                                          	|
| ACQ_SOCKET_PORT                	| `65432`                      	| Port for the interprocess socket communication. **Note: ** If you run multiple acquision containers on the same device, they will share all their ports, hence each container needs to have this port set up to a different value. Moreover, even after stopping of a container, this port will not be reusable in the next 2 minutes. If one tries to run another container with the same port they will observe an error. 	|
| ACQ_UPDATE_RATE                	| `2`                          	| This is the frequency of image processing and april tag extraction. Higher values are recommended for performance but need more computational resources.                                                                                                                                                                                                                                                                    	|
| ACQ_TEST_STREAM                	| `1`                          	| Boolean, `1` or `0`. If set to `1` will also publish the raw, rectified and info streams to the ACQ_ROS_MASTER_URI_SERVER                                                                                                                                                                                                                                                                                                   	|
| ACQ_BEAUTIFY                   	| `1`                          	| Boolean, `1` or `0`. If set to `1` will attempt to automatically improve the contrast of the raw image.                                                                                                                                                                                                                                                                                                                     	|
| ACQ_TOPIC_RAW                  	| `camera_node/image/raw`      	| Topic name for the raw image stream of the device whose data this container will be processing                                                                                                                                                                                                                                                                                                                              	|
| ACQ_TOPIC_CAMERAINFO           	| `camera_node/camera_info`    	| Topic name for the camera information stream of the device whose data this container will be processing                                                                                                                                                                                                                                                                                                                     	|
| ACQ_TOPIC_VELOCITY_TO_POSE     	| `velocity_to_pose_node/pose` 	| Topic name for the odometry pose stream of the device whose data this container will be processing (meaningful only for Duckiebots)                                                                                                                                                                                                                                                                                         	|
| ACQ_TAG_SIZE                   	| `0.065`                      	| April tag size in meters                                                                                                                                                                                                                                                                                                                                                                                                    	|
| ACQ_POSES_TOPIC                	| `poses`                      	| Name for the relative poses topic on ACQ_ROS_MASTER_URI_SERVER                                                                                                                                                                                                                                                                                                                                                              	|
| ACQ_ODOMETRY_TOPIC             	| `odometry`                   	| Name for the odometry poses topic on ACQ_ROS_MASTER_URI_SERVER                                                                                                                                                                                                                                                                                                                                                              	|

The easiest way to get started is to edit one of the example `.yml` files provided. Note that if you run the container directly (without a docker-compose file), then you need to pass the `--network host` parameter.

Before starting the container make sure your devices are publishing the necessary topics (at least raw images and camera information, optionally odometry information). For example:
- Robotarium watchtowers: `ssh` in the watchtower and run:
  ```
  cd duckietown
  git checkout devel-auto-localization-system-calibration
  make auto_localization_watchtower
  ```
- DT18 Duckiebots: make sure the following containers are running
  - `roscore` (`duckietown/rpi-ros-kinetic-roscore:master18`)
  - `ros-picam` (`duckietown/rpi-duckiebot-ros-picam:master18`)
  - `joystick` (`duckietown/rpi-duckiebot-joystick-demo:master18`)

Also check that `roscore` is running on the `ACQ_ROS_MASTER_URI_SERVER` device.

Once all that is done you can start all the containers set up in the `.yml` file with:
```
docker-compose -f docker-compose-file.yml up
```
Now, if everything is running smoothly you will start receiving data on the ROS Master on `ACQ_ROS_MASTER_URI_SERVER`.

## How does the acquisition node work?
